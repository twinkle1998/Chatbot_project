<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EmpathyBot ‚ù§Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    }
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: flex-end;
      align-items: flex-end;
      position: relative;
      background: linear-gradient(145deg, #1B2526 0%, #0F1414 100%);
      overflow-x: hidden;
    }
    .background-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80') no-repeat center center/cover;
      filter: blur(5px) opacity(0.5);
      z-index: -1;
    }
    .website-header {
      position: fixed;
      top: 0;
      width: 100%;
      height: 0.1%;
      background: linear-gradient(rgba(31, 33, 41, 0.9) -34%, rgba(26, 28, 35, 0.9) 100%);
      backdrop-filter: blur(10px);
      padding: 20px 60px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1001;
      font-family: 'Poppins', 'Segoe UI', sans-serif;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .website-logo {
      display: flex;
      align-items: center;
      color: #FFFFFF;
      font-size: 28px;
      font-weight: 700;
    }
    .website-logo:hover {
      transform: rotate(360deg);
    }
    .website-logo svg {
      width: 28px;
      height: 28px;
      margin-right: 12px;
    }
    .website-logo span {
      font-size: 16px;
      color: #CCCCCC;
      margin-left: 8px;
      font-weight: 400;
    }
    .website-nav {
      flex: 1;
      display: flex;
      justify-content: center;
    }
    .website-nav ul {
      list-style: none;
      display: flex;
      gap: 30px;
      align-items: center;
    }
    .website-nav ul li {
      color: #FFFFFF;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: color 0.3s, transform 0.3s, border 0.3s;
      position: relative;
      padding: 8px 16px;
      border-radius: 20px;
    }
    .website-nav ul li:hover {
      color: rgb(243, 156, 24);
      transform: scale(1.1);
      background: rgba(243, 156, 24, 0.1);
    }
    .website-nav ul li.active {
      color: rgb(243, 156, 24);
      background: rgba(243, 156, 24, 0.2);
      box-shadow: 0 0 10px rgba(243, 156, 24, 0.5);
    }
    .website-content {
      position: absolute;
      top: 100px;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 1250px;
      height: calc(100vh - 120px);
      padding: 20px;
      z-index: 0;
      font-family: 'Poppins', 'Segoe UI', sans-serif;
      color: #FFFFFF;
    }
    .website-content::-webkit-scrollbar {
      width: 8px;
    }
    .website-content::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }
    .website-content::-webkit-scrollbar-thumb {
      background: rgb(243, 156, 24);
      border-radius: 10px;
    }
    .tab-content {
      display: none;
      opacity: 0;
      animation: fadeIn 0.5s forwards;
    }
    .tab-content.active {
      display: block;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .tab-content h1 {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 20px;
      color: rgb(243, 156, 24);
      text-align: center;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }
    .tab-content h2 {
      font-size: 24px;
      font-weight: 600;
      margin: 15px 0 10px;
      color: #FFFFFF;
      border-bottom: 2px solid rgb(243, 156, 24);
      display: inline-block;
      padding-bottom: 5px;
    }
    .tab-content p {
      font-size: 16px;
      line-height: 1.6;
      margin-bottom: 15px;
      color: #CCCCCC;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    .team-section {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-top: 40px;
    }
    .team-section h1 {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 20px;
      color: rgb(243, 156, 24);
      text-align: center;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      width: 100%;
    }
    .team-card {
      background: rgba(27, 37, 38, 0.9);
      border-radius: 10px;
      padding: 20px;
      width: 300px;
      text-align: center;
      transition: transform 0.3s, box-shadow 0.3s;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    .team-card:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
    }
    .team-card h3 {
      font-size: 20px;
      font-weight: 600;
      color: rgb(243, 156, 24);
      margin-bottom: 10px;
    }
    .team-card p {
      font-size: 14px;
      color: #CCCCCC;
      margin-bottom: 10px;
    }
    .chat-widget {
      width: 496.8px;
      height: 717.6px;
      background-color: #FFFFFF;
      border-radius: 40px 40px 20px 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: none;
      flex-direction: column;
      position: fixed;
      bottom: 100px;
      right: 20px;
      z-index: 1000;
      transform: scaleY(0);
      transform-origin: bottom;
      transition: transform 0.5s ease-in-out;
    }
    .chat-widget.active {
      display: flex;
      transform: scaleY(1);
      animation: paperOpen 0.5s ease-in-out forwards;
    }
    @keyframes paperOpen {
      0% { transform: scaleY(0); opacity: 0; }
      50% { transform: scaleY(1.1); opacity: 0.5; }
      100% { transform: scaleY(1); opacity: 1; }
    }
    .tab-section {
      display: none;
      flex: 1;
      flex-direction: column;
      height: 100%;
    }
    .tab-section.active {
      display: flex;
    }
    .home-section {
      background: transparent;
    }
    .home-header {
      padding: 20px;
      color: #FFFFFF;
      display: flex;
      align-items: flex-start;
    }
    .home-header .logo {
      width: 40px;
      height: 40px;
    }
    .home-header h1 {
      font-size: 33px;
      font-weight: 600;
      margin-bottom: 5px;
      margin-left: 10px;
      margin-top: 30px;
      color: #000000;
    }
    .home-header h1 span {
      font-size: 27.5px;
      font-weight: 400;
    }
    .home-body {
      flex: 1;
      padding: 0 20px 20px 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      background-color: #FFFFFF;
    }
    .home-main {
      display: block;
    }
    .home-main.hidden {
      display: none;
    }
    .chat-container {
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 15px;
      margin-top: 20px;
      background-color: #FFFFFF;
    }
    .home-detail {
      display: none;
      background-color: #FFFFFF;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      scroll-behavior: smooth;
    }
    .home-detail.active {
      display: block;
    }
    .home-detail-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    .home-detail-header .back-arrow {
      cursor: pointer;
      font-size: 24.75px;
      color: rgb(243, 156, 24);
      margin-right: 10px;
      display: block;
    }
    .home-detail-header h2 {
      font-size: 22px;
      font-weight: 600;
      color: #333333;
    }
    .home-detail-content p {
      font-size: 19.25px;
      color: #333333;
      line-height: 1.5;
      margin-bottom: 10px;
    }
    .home-detail-content p:last-child {
      margin-bottom: 0;
    }
    .home-detail-content iframe {
      width: 100%;
      height: 200px;
      border: 0;
      border-radius: 8px;
      margin-top: 10px;
    }
    .search-result {
      display: none;
      background-color: #FFFFFF;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .search-result.active {
      display: block;
    }
    .search-result-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    .search-result-header h2 {
      font-size: 22px;
      font-weight: 600;
      color: #333333;
    }
    .search-result-header .clear-search {
      cursor: pointer;
      font-size: 19.25px;
      color: rgb(243, 156, 24);
    }
    .search-result-content p {
      font-size: 19.25px;
      color: #333333;
      line-height: 1.5;
      margin-bottom: 10px;
    }
    .recent-chats-label {
      font-size: 16.5px;
      color: rgb(243, 156, 24);
      margin-bottom: 5px;
    }
    .recent-message {
      background-color: #FFFFFF;
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      font-size: 19.25px;
      color: #000000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background-color 0.2s, color 0.2s;
    }
    .recent-message:hover {
      background-color: #F5F5F5;
      color: rgb(243, 156, 24);
    }
    .recent-message img {
      width: 20px;
      height: 20px;
      margin-right: 8px;
      border-radius: 50%;
    }
    .recent-message .arrow {
      color: rgb(243, 156, 24);
      font-size: 24.75px;
    }
    .start-new-chat-label {
      font-size: 16.5px;
      color: rgb(243, 156, 24);
      margin: 10px 0 5px 0;
    }
    .new-chat-option {
      background-color: #FFFFFF;
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      font-size: 19.25px;
      color: #333333;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background-color 0.2s, color 0.2s;
    }
    .new-chat-option.disabled {
      background-color: #E5E5E5;
      color: #999999;
      cursor: not-allowed;
    }
    .new-chat-option:hover:not(.disabled) {
      background-color: #F5F5F5;
      color: rgb(243, 156, 24);
    }
    .new-chat-option .arrow {
      color: rgb(243, 156, 24);
      font-size: 24.75px;
    }
    .faq-section {
      margin-top: 20px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 10px;
      padding: 10px;
    }
    .faq-section h3 {
      font-size: 16.5px;
      color: rgb(243, 156, 24);
      margin-bottom: 10px;
    }
    .faq-item {
      background-color: #FFFFFF;
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      font-size: 19.25px;
      color: #333333;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background-color 0.2s, color 0.2s;
    }
    .faq-item:hover {
      background-color: #F5F5F5;
      color: rgb(243, 156, 24);
    }
    .faq-item .arrow {
      color: rgb(243, 156, 24);
      font-size: 24.75px;
    }
    .search-bar {
      width: 100%;
      padding: 10px 15px;
      border: none;
      border-radius: 20px;
      margin: 15px 0;
      font-size: 19.25px;
      color: #333333;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path fill="rgb(243,156,24)" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>') no-repeat 95% center;
      background-size: 16px;
    }
    .search-bar:hover::placeholder {
      color: rgb(243, 156, 24);
    }
    .home-item {
      background-color: #FFFFFF;
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      font-size: 19.25px;
      color: #333333;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background-color 0.2s, color 0.2s;
    }
    .home-item:hover {
      background-color: #F5F5F5;
      color: rgb(243, 156, 24);
    }
    .home-item .arrow {
      color: rgb(243, 156, 24);
      font-size: 24.75px;
    }
    .pricing-link {
      background-color: #F5F5F5;
      padding: 12px 15px;
      border-radius: 10px;
      font-size: 19.25px;
      color: #333333;
      cursor: pointer;
      transition: background-color 0.2s, color 0.2s;
    }
    .pricing-link:hover {
      background-color: #E5E5E5;
      color: rgb(243, 156, 24);
    }
    .messages-header {
      padding: 12px 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #E5E5E5;
      position: sticky;
      top: 0;
      background-color: #FFFFFF;
      z-index: 1;
      flex-shrink: 0;
      height: 63px;
    }
    .messages-header .header-left {
      display: flex;
      align-items: center;
    }
    .messages-header .back-arrow {
      cursor: pointer;
      font-size: 24.75px;
      color: rgb(243, 156, 24);
      margin-right: 10px;
    }
    .messages-header .header-title {
      display: flex;
      flex-direction: column;
    }
    .messages-header .header-title .title {
      display: flex;
      align-items: center;
      font-size: 22px;
      font-weight: 600;
      color: #333333;
    }
    .messages-header .header-title .title img {
      width: 16px;
      height: 16px;
      margin-right: 5px;
    }
    .messages-header .header-title .subtext {
      font-size: 16.5px;
      color: #666666;
    }
    .messages-header .download-icon {
      cursor: pointer;
      font-size: 22px;
      color: rgb(243, 156, 24);
      position: relative;
    }
    .messages-header .download-icon:hover::after {
      content: "Download Transcript";
      position: absolute;
      top: -30px;
      right: 0;
      background-color: rgb(243, 156, 24);
      color: #FFFFFF;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 14px;
      white-space: nowrap;
      z-index: 10;
    }
    .messages-body {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background-color: #FFFFFF;
      scroll-behavior: smooth;
      min-height: 0;
      height: auto;
    }
    .messages-body::-webkit-scrollbar {
      width: 6px;
    }
    .messages-body::-webkit-scrollbar-track {
      background: #E5E5E5;
      border-radius: 10px;
    }
    .messages-body::-webkit-scrollbar-thumb {
      background: #999999;
      border-radius: 10px;
    }
    .messages-body::-webkit-scrollbar-thumb:hover {
      background: #666666;
    }
    .chat-date {
      font-size: 12px;
      color: #999999;
      text-align: center;
      margin: 8px 0;
      background: transparent;
      padding: 4px;
      border-radius: 8px;
    }
    .message {
      margin-bottom: 15px;
      display: flex;
      align-items: flex-start;
      flex-direction: column;
      flex-shrink: 0;
      opacity: 0;
      animation: fadeIn 1.5s forwards;
    }
    @keyframes fadeIn {
      to { opacity: 1; }
    }
    .message.bot {
      align-self: flex-start;
    }
    .message.user {
      align-self: flex-end;
      margin-left: auto;
    }
    .message .bubble {
      padding: 10px 14px;
      border-radius: 15px;
      font-size: 19.25px;
      line-height: 1.5;
      max-width: 80%;
      display: inline-block;
      border: 1px solid #E5E5E5;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    .message.bot .bubble {
      background-color: rgb(245, 245, 245);
      color: #000000;
      border-top-left-radius: 0;
      display: flex;
      flex-direction: column;
    }
    .message.bot .bubble .sender {
      font-weight: bold;
      margin-bottom: 4px;
    }
    .message.bot .audio-container {
      margin-left: 28px;
      margin-top: 5px;
    }
    .message.bot .audio-container audio {
      width: 100px;
      height: 20px;
    }
    .message.user .bubble {
      background-color: rgb(243, 156, 24);
      color: #FFFFFF;
      border-top-right-radius: 0;
      display: flex;
      flex-direction: column;
      border: 1px solid rgb(243, 156, 24, 0.2);
    }
    .message.user .bubble .sender {
      font-weight: bold;
      margin-bottom: 4px;
    }
    .message.user .timestamp {
      font-size: 16.5px;
      color: #666666;
      align-self: flex-end;
      margin-top: 4px;
    }
    .typing-indicator {
      display: flex;
      align-items: center;
      margin: 10px 0;
    }
    .typing-indicator .dot {
      width: 10px;
      height: 10px;
      background: #999999;
      border-radius: 50%;
      margin-right: 6px;
      animation: float 1.5s infinite ease-in-out;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    .typing-indicator .dot:nth-child(1) {
      animation-delay: 0s;
    }
    .typing-indicator .dot:nth-child(2) {
      animation-delay: 0.3s;
    }
    .typing-indicator .dot:nth-child(3) {
      animation-delay: 0.6s;
    }
    @keyframes float {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-10px);
      }
    }
    .messages-footer {
      padding: 10px 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #FFFFFF;
      border-top: 1px solid #E5E5E5;
      position: sticky;
      bottom: 0;
      z-index: 1;
      flex-shrink: 0;
      transition: transform 0.3s ease-in-out;
    }
    .messages-footer.active {
      transform: translateY(-10px);
    }
    .input-container {
      display: flex;
      flex-direction: row;
      width: 100%;
      gap: 8px;
      align-items: center;
    }
    .input-row {
      display: flex;
      align-items: center;
      width: 100%;
      border: 1px solid #E5E5E5;
      border-radius: 20px;
      padding: 5px 10px;
    }
    .input-row input {
      flex: 1;
      padding: 8px 12px;
      border: none;
      outline: none;
      font-size: 19.25px;
      color: #333333;
    }
    .input-row input:disabled {
      background-color: #E5E5E5;
      cursor: not-allowed;
    }
    .input-row input:focus {
      outline: none;
    }
    .input-row input:focus + .send-btn {
      color: darkgrey;
    }
    .send-btn, .mic-btn {
      width: 30px;
      height: 30px;
      background: none;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 5px;
      color: grey;
    }
    .send-btn img {
      width: 16px;
      height: 16px;
      filter: invert(50%);
    }
    .mic-btn:hover, .send-btn:hover {
      background: none;
      color: darkgrey;
    }
    .suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
      justify-content: flex-start;
    }
    .suggestions.hidden {
      display: none;
    }
    .suggestion-btn {
      background: transparent;
      color: rgb(243, 156, 24);
      border: 1px solid rgb(243, 156, 24);
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .suggestion-btn:hover {
      background: rgba(243, 156, 24, 0.1);
    }
    .end-chat-btn {
      background-color: rgb(243, 156, 24);
      padding: 12px 15px;
      border-radius: 10px;
      font-size: 19.25px;
      color: #FFFFFF;
      text-align: center;
      cursor: pointer;
      margin: 10px 0;
      transition: background-color 0.2s, color 0.2s;
    }
    .end-chat-btn:hover {
      background-color: rgb(223, 136, 4);
    }
    .navbar {
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      background-color: #FFFFFF;
      border-bottom-left-radius: 20px;
      border-bottom-right-radius: 20px;
      border-top: 1px solid #E5E5E5;
      position: sticky;
      bottom: 0;
      z-index: 10;
      flex-shrink: 0;
    }
    .navbar div {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      font-size: 16.5px;
      color: #999999;
      padding: 5px;
    }
    .navbar div:hover {
      color: rgb(243, 156, 24);
    }
    .navbar div:hover svg path {
      fill: rgb(243, 156, 24);
    }
    .navbar div.active {
      color: rgb(243, 156, 24);
    }
    .navbar div.active svg path {
      fill: rgb(243, 156, 24);
    }
    .navbar div svg path {
      fill: #999999;
    }
       .message-icon {
  position: fixed;
  bottom: 50px;
  right: 50px;
  width: 130px;
  height: 50px;
  background-color: rgb(243, 156, 24);
  border-radius: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
  z-index: 1000;
  animation: popUp 0.5s ease-out forwards;
  transition: transform 0.3s ease-in-out;
  gap: 8px;
}

.message-icon .icon-circle {
  width: 24px;
  height: 24px;
  background-color: transparent;
  border: 2px solid #FFFFFF;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  color: #FFFFFF;
  font-family: 'Segoe UI', sans-serif;
  font-weight: 600;
}

.message-icon span {
  font-size: 20px;
  color: #FFFFFF;
  font-family: 'Segoe UI', sans-serif;
  font-weight: 600;
}
    @keyframes popUp {
      0% {
        transform: scale(0);
        opacity: 0;
      }
      70% {
        transform: scale(1.2);
        opacity: 1;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
    .message-icon:hover {
      transform: scale(1.1);
    }
    .message-icon:active {
      transform: scale(0.95);
    }
    @keyframes pulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(243, 156, 24, 0.7); }
      70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(243, 156, 24, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(243, 156, 24, 0); }
    }
    .dialog-container {
      background-color: #FFFFFF;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .chat-ended-message {
      text-align: center;
      font-size: 19.25px;
      color: rgb(243, 156, 24);
      padding: 10px;
    }
    .contact-info {
      text-align: center;
      font-size: 16px;
      color: #333333;
      padding: 10px;
      line-height: 1.5;
    }
    .warning-dialog {
      background-color: rgba(243, 156, 24, 0.1);
      border: 1px solid rgba(243, 156, 24, 0.3);
      border-radius: 12px;
      padding: 15px;
      margin: 10px 0;
      font-size: 19.25px;
      color: #333333;
      text-align: center;
      position: relative;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      animation: fadeSlideIn 0.5s ease-out forwards;
      backdrop-filter: blur(5px);
    }
    @keyframes fadeSlideIn {
      0% { opacity: 0; transform: translateY(-20px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .warning-dialog .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
      font-size: 16.5px;
      color: #666666;
      transition: color 0.2s;
    }
    .warning-dialog .close-btn:hover {
      color: rgb(243, 156, 24);
    }
    .warning-dialog .action-btn {
      margin-top: 10px;
      background-color: rgb(243, 156, 24);
      color: #FFFFFF;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      display: inline-block;
      transition: background-color 0.2s;
    }
    .warning-dialog .action-btn:hover {
      background-color: rgb(223, 136, 4);
    }
    @media screen and (max-width: 768px) {
      .chat-widget {
        width: 95%;
        height: 85vh;
        max-height: 600px;
        border-radius: 20px;
        bottom: 80px;
        right: 2.5%;
        left: 2.5%;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }
      .chat-widget.active {
        transform: scaleY(1);
      }
      .message-icon {
        bottom: 15px;
        right: 15px;
        width: 45px;
        height: 45px;
      }
      .message-icon::before {
        font-size: 20px;
      }
      .home-header {
        padding: 15px;
      }
      .home-header h1 {
        font-size: 24px;
      }
      .home-header h1 span {
        font-size: 20px;
      }
      .home-body {
        padding: 0 15px 15px 15px;
      }
      .home-detail-header h2 {
        font-size: 18px;
      }
      .home-detail-content p {
        font-size: 16px;
        line-height: 1.4;
      }
      .home-detail-content iframe {
        height: 150px;
      }
      .search-bar {
        font-size: 16px;
        padding: 8px 12px;
        background-size: 14px;
      }
      .search-result-header h2 {
        font-size: 18px;
      }
      .search-result-content p {
        font-size: 16px;
      }
      .recent-chats-label, .start-new-chat-label, .faq-section h3 {
        font-size: 14px;
      }
      .recent-message, .new-chat-option, .home-item, .faq-item {
        font-size: 16px;
        padding: 10px 12px;
      }
      .recent-message .arrow, .new-chat-option .arrow, .home-item .arrow, .faq-item .arrow {
        font-size: 20px;
      }
      .messages-header {
        padding: 10px 12px;
        height: 50px;
      }
      .messages-header .back-arrow {
        font-size: 20px;
      }
      .messages-header .header-title .title {
        font-size: 18px;
      }
      .messages-header .header-title .subtext {
        font-size: 14px;
      }
      .messages-header .download-icon {
        font-size: 18px;
      }
      .messages-body {
        padding: 12px;
      }
      .message .bubble {
        font-size: 15px;
        padding: 8px 12px;
        max-width: 85%;
      }
      .message.bot .audio-container audio {
        width: 80px;
        height: 18px;
      }
      .message.user .timestamp {
        font-size: 14px;
      }
      .messages-footer {
        padding: 8px 12px;
      }
      .input-row input {
        font-size: 16px;
        padding: 6px 10px;
      }
      .send-btn, .mic-btn {
        width: 28px;
        height: 28px;
        margin-left: 3px;
      }
      .send-btn img {
        width: 14px;
        height: 14px;
      }
      .suggestion-btn {
        font-size: 12px;
        padding: 5px 10px;
      }
      .navbar {
        padding: 8px 0;
      }
      .navbar div {
        font-size: 14px;
      }
      .navbar div svg {
        width: 18px;
        height: 18px;
      }
      .end-chat-btn {
        font-size: 16px;
        padding: 10px 12px;
      }
      .chat-ended-message {
        font-size: 16px;
      }
      .contact-info {
        font-size: 14px;
      }
      .warning-dialog {
        font-size: 16px;
        padding: 12px;
      }
      .warning-dialog .close-btn {
        font-size: 14px;
      }
      .warning-dialog .action-btn {
        font-size: 14px;
        padding: 6px 12px;
      }
    }
  </style>
</head>
<body>
  <div class="background-overlay"></div>
  <header class="website-header">
    <div class="website-logo">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="rgb(243, 156, 24)"/>
      </svg>
      EmpathyBot
    </div>
    <nav class="website-nav">
      <ul>
      </ul>
    </nav>
  </header>
  <div class="website-content">
    <div id="home" class="tab-content active">
      <h1>Welcome to EmpathyBot</h1>
      <h2>An AI-Powered Empathetic Customer Service System</h2>
      <p>EmpathyBot is a conversational product review system designed to enhance user engagement through human-like interactions. Built for the Master of Data Science and Innovation program at the University of Technology of Sydney, this project (Assignment 2, Group 11) leverages NLP and a multi-agent framework to provide empathetic responses to customer feedback.</p>
      <p>Our system transforms traditional review forms into a dynamic, chat-based experience, powered by CrewAI‚Äôs modular agent coordination for sentiment analysis and response generation. Deployed using FastAPI, Uvicorn, and Docker on Render, EmpathyBot offers a seamless and scalable user experience.</p>
      <div class="team-section">
        <h1>Our Team</h1>
        <div class="team-card">
          <h3>Tengjian Zhang</h3>
          <p>Selected the project dataset and designed the overall workflow, conducted data cleaning and EDA to support model development. Summarized meeting discussions for team alignment. Contributed to the Data and Outcomes sections of the report.</p>
        </div>
        <div class="team-card">
          <h3>Xiaochen Xiao</h3>
          <p>Constructed the original baseline code for sentiment analysis, LLM, and keyword detection. Established the GitHub repository. Contributed to the Modeling and Key Findings sections of the report.</p>
        </div>
        <div class="team-card">
          <h3>Iqbal Muhammad</h3>
          <p>Executing the dataset integration, conducting a thorough investigation of potential approaches for employing multi agent frame work and opprtunities to leverage API. Developing, testing, and fine-tuning the multi-agent system. Benchmarking local LLM and Gemini's responses, responsible for challenges and recommendations section in the project.</p>
        </div>
        <div class="team-card">
          <h3>Ratana Sovann</h3>
          <p>Identified resources and insights to enhance the project. Oversaw progress, ensured task distribution, and aligned with objectives. Responsible for the Summary and Project Overview sections of the report.</p>
        </div>
        <div class="team-card">
          <h3>Twinkle Kashyap</h3>
          <p>Led exploratory data analysis and pre-processing to ensure robust data quality. Designed innovative approaches for multi-agent frameworks, seamlessly integrating frontend and backend systems. Crafted and fine-tuned modeling prompts, developed an intuitive UI, and spearheaded deployment. Iteratively tested use cases, refining the model for optimal performance, and contributed to the approach and deployment sections of the project.</p>
        </div>
      </div>
    </div>
    <div id="eda" class="tab-content">
      <h1>Exploratory Data Analysis (EDA)</h1>
      <h2>Data Source</h2>
      <p>We utilized the Amazon US Customer Reviews Dataset from Kaggle, containing 449,172 records across 148 product categories. We sampled 2,000 reviews per rating (1‚Äì5 stars) to ensure diversity.</p>
      <h2>Data Structure</h2>
      <p>The dataset includes fields like review_headline, review_body, star_rating, and product_category. We examined data dimensions, handled missing values, and removed duplicates.</p>
      <h2>Key Insights</h2>
      <p>Sentiment tagging was performed based on star ratings: 1‚Äì2 stars (negative), 3 stars (neutral), 4‚Äì5 stars (positive). Visualizations showed a majority of positive reviews, with word clouds highlighting terms like "great" in positive reviews and "delay" in negative ones.</p>
    </div>
    <div id="pre-processing" class="tab-content">
      <h1>Pre Processing of Data</h1>
      <h2>Text Cleaning</h2>
      <p>We cleaned review text by removing HTML tags, non-alphabetic characters, and stopwords, and expanded contractions for consistency.</p>
      <h2>Normalization</h2>
      <p>Converted text to lowercase and standardized formats to prepare for NLP tasks.</p>
      <h2>Preparation for Modelling</h2>
      <p>Performed tokenization and lemmatization to reduce words to their base forms, ensuring efficient input for sentiment analysis.</p>
    </div>
    <div id="data-cleaning" class="tab-content">
      <h1>Data Cleaning by NLP Techniques</h1>
      <h2>Noise Removal</h2>
      <p>Applied NLP techniques to remove noise such as emojis, punctuation, and irrelevant characters from the reviews.</p>
      <h2>Sentiment Tagging</h2>
      <p>Tagged sentiments based on star ratings and preserved negations to maintain context.</p>
      <h2>Lexical Patterns</h2>
      <p>Used word clouds to identify lexical patterns, such as frequent terms in positive and negative reviews.</p>
    </div>
    <div id="modelling" class="tab-content">
      <h1>Modelling</h1>
      <h2>Multi-Agent Framework</h2>
      <p>Adopted CrewAI‚Äôs four-stage pipeline: Sentiment Analysis Agent (Gemini 2.0 Flash-Lite), Sentiment Review Agent (Gemini 2.0 Flash), Response Generation Agent, and Polishing Agent for compliance checks.</p>
      <h2>Prompt Engineering</h2>
      <p>Designed hierarchical prompt templates with dynamic variable injection, achieving a 37% increase in response relevance. Templates ensured compliance and appropriate tone.</p>
      <h2>Key Findings</h2>
      <p>Gemini 2.0 Flash excelled in positive scenarios (4.7/5 score) but struggled with long texts (>300 words, 21% accuracy drop). Two-stage sentiment analysis identified 82% of contradictory semantics.</p>
    </div>
    <div id="deployment" class="tab-content">
      <h1>Deployment</h1>
      <h2>Backend Integration</h2>
      <p>Deployed using FastAPI, Uvicorn, and Docker on Render, ensuring scalable access and seamless API integration.</p>
      <h2>Frontend Design</h2>
      <p>Developed a clean, cheerful UI with React (now updated to pure HTML/CSS/JS for simplicity), focusing on an engaging chat experience.</p>
      <h2>User Interaction</h2>
      <p>Users interact via a chat interface, inputting their name, purchase date, product, and issue. The system supports speech-to-text and multilingual compatibility.</p>
    </div>
    <div id="challenges" class="tab-content">
      <h1>Challenges Faced</h1>
      <h2>Dataset Size</h2>
      <p>The Amazon dataset (54 GB, 57 CSV files) was challenging to process. We adopted a partial-import strategy, sampling 2,000 rows per rating to maintain proportionality.</p>
      <h2>Model Selection</h2>
      <p>Fine-tuning pretrained models was resource-intensive. We switched to CrewAI‚Äôs agent framework, using Gemini 2.0 Flash for better performance.</p>
      <h2>Agent Configuration</h2>
      <p>Determined an optimal four-agent structure (Sentiment, Sentiment Review, Response, Reviewer) after multiple trials to balance complexity and performance.</p>
    </div>
  </div>
  <div id="chat-widget" class="chat-widget">
    <div class="tab-section home-section active" id="home-section">
      <div class="home-header">
        <svg class="logo" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="rgb(243, 156, 24)"></path>
        </svg>
        <h1>Hey there, how can we help?</h1>
      </div>
      <div class="home-body">
        <div class="home-main" id="home-main">
          <div class="chat-container">
            <div class="start-new-chat-label">Start New Chat</div>
            <div class="new-chat-option" id="new-chat-option" onclick="startNewChat()">
              <span>Share Your Feedback or Report an Issue</span>
              <span class="arrow">></span>
            </div>
          </div>
          <input type="text" class="search-bar" id="search-bar" placeholder="Search for help">
          <div class="search-result" id="search-result">
            <div class="search-result-header">
              <h2>Search Result</h2>
              <div class="clear-search" onclick="clearSearch()">Clear Search</div>
            </div>
            <div class="search-result-content" id="search-result-content">
              <div class="home-item" onclick="sendSuggestion('Check Order Status')">
                Check Order Status <span class="arrow">></span>
              </div>
              <div class="home-item" onclick="sendSuggestion('Track Order')">
                Track Order <span class="arrow">></span>
              </div>
              <div class="home-item" onclick="sendSuggestion('Cancel Order')">
                Cancel Order <span class="arrow">></span>
              </div>
              <div class="home-item" onclick="sendSuggestion('Talk to an Agent')">
                Talk to an Agent <span class="arrow">></span>
              </div>
            </div>
          </div>
          <div class="faq-section">
            <h3>FAQs</h3>
            <div class="faq-item" onclick="showDetail('how-to-use')">
              How to Use This Chatbot <span class="arrow">></span>
            </div>
            <div class="faq-item" onclick="showDetail('chat-ends')">
              When Chat Ends, Go to Home Page and Start New <span class="arrow">></span>
            </div>
            <div class="faq-item" onclick="showDetail('recent-chats-24')">
              Recent Chats Will Be Available Forever <span class="arrow">></span>
            </div>
            <div class="faq-item" onclick="showDetail('ethical-content')">
              Ethical Content Guidelines for Server Response <span class="arrow">></span>
            </div>
          </div>
        </div>
        <div class="home-detail" id="detail-how-to-use">
          <div class="home-detail-header">
            <div class="back-arrow" onclick="hideDetail()"><</div>
            <h2>How to Use This Chatbot</h2>
          </div>
          <div class="home-detail-content">
            <p>The Amazon Chatbot is designed to assist you with your shopping needs in a simple and intuitive way. To get started, click the message icon at the bottom-right corner of the screen to open the chat widget.</p>
            <p>From the "Home" tab, select "Share Your Feedback or Report an Issue" to begin a new conversation, or explore helpful articles by clicking on options like "What is This Chatbot For?" or "Getting Started with Amazon Chatbot."</p>
            <p>In the "Messages" tab, the chatbot will guide you step-by-step‚Äîfirst asking for your name, then the purchase date, the product, and finally your feedback or issue.</p>
            <p>You can also use the search bar on the "Home" tab to quickly find help on specific topics, or use the microphone button to send voice messages for a hands-free experience.</p>
            <iframe src="https://drive.google.com/file/d/1y3nhbOf3fTLT04r0iBgw9ee9zArB33Gs/preview" allow="autoplay" allowfullscreen></iframe>
          </div>
        </div>
        <div class="home-detail" id="detail-chat-ends">
          <div class="home-detail-header">
            <div class="back-arrow" onclick="hideDetail()"><</div>
            <h2>When Chat Ends, Go to Home Page and Start New</h2>
          </div>
          <div class="home-detail-content">
            <p>Once your conversation with the Amazon Chatbot concludes, you‚Äôll be automatically directed back to the "Home" tab to ensure a seamless experience. This reset allows you to easily start a fresh chat without lingering on previous conversations.</p>
            <p>To begin a new chat, simply click "Share Your Feedback or Report an Issue" again, and the chatbot will restart the process by asking for your name, purchase date, product, and feedback.</p>
            <p>This feature ensures that each interaction is independent, keeping your experience organized and focused on your current needs.</p>
          </div>
        </div>
        <div class="home-detail" id="detail-recent-chats-24">
          <div class="home-detail-header">
            <div class="back-arrow" onclick="hideDetail()"><</div>
            <h2>Recent Chats Will Be Available Forever</h2>
          </div>
          <div class="home-detail-content">
            <p>Your recent conversations with the Amazon Chatbot are conveniently displayed under the "Recent Chats" section on the "Home" tab, allowing you to revisit them if needed.</p>
            <p>These chats are now stored indefinitely in local storage, so you can access them anytime without worrying about expiration.</p>
            <p>If you wish to continue a conversation, simply click on it to reopen it, or start a new chat by selecting "Share Your Feedback or Report an Issue."</p>
          </div>
        </div>
        <div class="home-detail" id="detail-ethical-content">
          <div class="home-detail-header">
            <div class="back-arrow" onclick="hideDetail()"><</div>
            <h2>Ethical Content Guidelines for Server Response</h2>
          </div>
          <div class="home-detail-content">
            <p>The Amazon Chatbot is committed to fostering a respectful and supportive environment, and as such, the server will only respond to messages that adhere to ethical content guidelines.</p>
            <p>Please use polite and appropriate language when interacting with the chatbot, avoiding any offensive, discriminatory, or harmful content. For example, instead of saying, "This product is trash," try, "I‚Äôm not satisfied with this product because of its quality."</p>
            <p>If your message contains inappropriate language, the server may not respond, and you‚Äôll receive a message like, "Sorry, there was an error reaching the server. Please try again later." Let‚Äôs keep the conversation friendly and constructive to ensure the best experience for everyone.</p>
          </div>
        </div>
      </div>
    </div>
    <div class="tab-section messages-section" id="messages-section">
      <div class="messages-header">
        <div class="header-left">
          <div class="back-arrow" onclick="switchTab('home')"><</div>
          <div class="header-title">
            <div class="title">EmpathyBot</div>
            <div class="subtext">We‚Äôre here to assist you</div>
          </div>
        </div>
        <div class="download-icon" onclick="downloadTranscript()">‚ãÆ</div>
      </div>
      <div class="messages-body" id="chat-box">
        <div class="message bot">
          <div class="bubble">
            <span class="sender">EmpathyBot</span>
            <span>Hi! What's your name?</span>
          </div>
        </div>
      </div>
      <div class="messages-footer" id="messages-footer">
        <div class="suggestions" id="suggestions">
          <button class="suggestion-btn" onclick="sendSuggestion('Check Order Status')">Check Order Status</button>
          <button class="suggestion-btn" onclick="sendSuggestion('Cancel Order')">Cancel Order</button>
          <button class="suggestion-btn" onclick="sendSuggestion('Talk to an Agent')">Talk to an Agent</button>
        </div>
        <div class="end-chat-btn" onclick="endChat()">End Chat</div>
        <div class="input-container">
          <div class="input-row">
            <button class="mic-btn" onclick="startVoice()">üéôÔ∏è</button>
            <input type="text" id="user-input" placeholder="Message...">
            <button class="send-btn" onclick="sendMessage()">
              <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24'><path fill='%23FFFFFF' d='M2 21l21-9L2 3v7l15 2-15 2v7z'/></svg>" alt="Send">
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="navbar">
      <div id="home-tab" class="active">
        <svg width="20" height="20" viewBox="0 0 24 24"><path fill="rgb(243, 156, 24)" d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
        <span>Home</span>
      </div>
      <div id="messages-tab">
        <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#999999" d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
        <span>Messages</span>
      </div>
    </div>
  </div>
  <div class="message-icon" onclick="toggleChat()">
        <div class="icon-circle">?</div>
        <span>Help</span>

  <script>
    let name = "";
    let date = "";
    let product = "";
    let step = 0;
    let currentConversationId = null;
    let conversations = JSON.parse(localStorage.getItem('conversations')) || {};
    let isChatActive = false;
    let isTyping = false;
    let lastIntent = null;

    function toggleChat() {
      const chatWidget = document.getElementById('chat-widget');
      chatWidget.classList.toggle('active');
      if (chatWidget.classList.contains('active')) {
        startTimestampUpdates();
        updateNewChatOptionState();
        loadRecentMessages();
      }
    }

    function switchTab(tab) {
      document.querySelectorAll('.navbar div').forEach(div => div.classList.remove('active'));
      document.querySelectorAll('.tab-section').forEach(section => section.classList.remove('active'));
      document.getElementById(`${tab}-tab`).classList.add('active');
      document.getElementById(`${tab}-section`).classList.add('active');
      if (tab === 'messages') {
        if (!isChatActive) {
          loadConversationsList();
        }
      } else if (tab === 'home') {
        if (currentConversationId && conversations[currentConversationId]) {
          isChatActive = conversations[currentConversationId].active;
        } else {
          isChatActive = false;
        }
        hideDetail();
        clearSearch();
        startTimestampUpdates();
        updateNewChatOptionState();
        loadRecentMessages();
      }
    }

    function showWarningDialog() {
      const homeBody = document.querySelector('#home-section .home-body');
      const existingWarning = document.querySelector('.warning-dialog');
      if (existingWarning) {
        existingWarning.remove();
      }
      const warningDiv = document.createElement('div');
      warningDiv.className = 'warning-dialog';
      warningDiv.innerHTML = `
        <span class="close-btn" onclick="this.parentElement.remove()">√ó</span>
        <p>Please end the current chat before starting a new one.</p>
        <div class="action-btn" onclick="switchTab('messages'); this.parentElement.remove()">Go to Chat</div>
      `;
      homeBody.insertBefore(warningDiv, homeBody.firstChild);
      homeBody.scrollTop = 0;
    }

    function updateNewChatOptionState() {
      const newChatOption = document.getElementById('new-chat-option');
      if (isChatActive) {
        newChatOption.classList.add('disabled');
        newChatOption.onclick = () => {
          showWarningDialog();
        };
      } else {
        newChatOption.classList.remove('disabled');
        newChatOption.onclick = startNewChat;
      }
    }

    function startNewChat() {
      if (isChatActive) {
        showWarningDialog();
        return;
      }
      currentConversationId = Date.now().toString();
      step = 0;
      isChatActive = true;
      lastIntent = null;
      conversations[currentConversationId] = {
        messages: [],
        lastMessage: "",
        timestamp: new Date().toISOString(),
        name: "",
        date: "",
        product: "",
        step: 0,
        active: true,
        lastIntent: null
      };
      switchTab('messages');
      resetMessagesTab();
      updateNewChatOptionState();
      loadRecentMessages();
    }

    async function endChat() {
      if (currentConversationId && conversations[currentConversationId]) {
        try {
          const response = await fetch('/end_chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: currentConversationId })
          });
          if (response.ok) {
            conversations[currentConversationId].active = false;
            appendBotMessage("Chat ended. Start a new chat from the Home tab. ‚ù§Ô∏è", null, 0);
            const contactInfo = document.createElement('div');
            contactInfo.className = 'contact-info';
            contactInfo.innerHTML = `
              Customer Service Contact<br>
              customerservice@amazon.com<br>
              +1-800-123-4567<br>
              123 Amazon Way, Seattle, WA 98101
            `;
            document.getElementById('chat-box').appendChild(contactInfo);
            const footer = document.getElementById('messages-footer');
            footer.innerHTML = `<div class="chat-ended-message">Chat ended</div>`;
            localStorage.setItem('conversations', JSON.stringify(conversations));
            isChatActive = false;
            currentConversationId = null;
            lastIntent = null;
            updateNewChatOptionState();
            loadRecentMessages();
          } else {
            appendBotMessage("Failed to end the chat. Please try again.", null, 0);
          }
        } catch (error) {
          appendBotMessage("Error ending the chat. Please check your connection and try again.", null, 0);
        }
      }
    }

    function loadConversationsList() {
      if (isChatActive) return;
      const chatBox = document.getElementById('chat-box');
      const footer = document.getElementById('messages-footer');
      chatBox.innerHTML = '';
      footer.innerHTML = '';
      const conversationIds = Object.keys(conversations)
        .sort((a, b) => new Date(conversations[b].timestamp) - new Date(conversations[a].timestamp));
      if (conversationIds.length > 0) {
        const label = document.createElement('div');
        label.className = 'recent-chats-label';
        label.textContent = 'Recent Chats';
        chatBox.appendChild(label);
      }
      conversationIds.forEach(id => {
        const convo = conversations[id];
        if (convo.lastMessage) {
          const messageDiv = document.createElement('div');
          messageDiv.className = 'recent-message';
          messageDiv.onclick = () => loadConversation(id);
          messageDiv.innerHTML = `
            <div style="display: flex; align-items: center;">
              <span>${convo.lastMessage.slice(0, 20)}${convo.lastMessage.length > 20 ? '...' : ''}</span>
            </div>
            <span class="arrow">></span>
          `;
          chatBox.appendChild(messageDiv);
        }
      });
      scrollToBottom();
    }

    function loadRecentMessages() {
      const recentMessages = document.getElementById('recent-messages');
      recentMessages.innerHTML = '';
      const conversationIds = Object.keys(conversations)
        .sort((a, b) => new Date(conversations[b].timestamp) - new Date(conversations[a].timestamp));
      const ongoingChat = conversationIds.find(id => conversations[id].active);
      if (ongoingChat) {
        const convo = conversations[ongoingChat];
        if (convo.lastMessage) {
          const messageDiv = document.createElement('div');
          messageDiv.className = 'recent-message';
          messageDiv.onclick = () => {
            loadConversation(ongoingChat);
            switchTab('messages');
          };
          messageDiv.innerHTML = `
            <div style="display: flex; align-items: center;">
              <span>${convo.lastMessage.slice(0, 20)}${convo.lastMessage.length > 20 ? '...' : ''}</span>
            </div>
            <span class="arrow">></span>
          `;
          recentMessages.appendChild(messageDiv);
        }
      } else {
        if (conversationIds.length > 0) {
          const latestEndedChat = conversationIds[0];
          const convo = conversations[latestEndedChat];
          if (convo.lastMessage) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'recent-message';
            messageDiv.onclick = () => {
              loadConversation(latestEndedChat);
              switchTab('messages');
            };
            messageDiv.innerHTML = `
              <div style="display: flex; align-items: center;">
                <span>${convo.lastMessage.slice(0, 20)}${convo.lastMessage.length > 20 ? '...' : ''}</span>
              </div>
              <span class="arrow">></span>
            `;
            recentMessages.appendChild(messageDiv);
          }
        }
      }
    }

    function loadConversation(conversationId) {
      currentConversationId = conversationId;
      const conversation = conversations[conversationId];
      isChatActive = conversation.active;
      const chatBox = document.getElementById('chat-box');
      chatBox.innerHTML = `<div class="chat-date">${new Date(conversation.timestamp).toLocaleDateString()}</div>`;
      let lastSender = null;
      conversation.messages.forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${msg.type}`;
        const bubbleDiv = document.createElement('div');
        bubbleDiv.className = 'bubble';
        if (msg.type === 'bot' && lastSender === 'bot') {
          bubbleDiv.style.borderTopLeftRadius = '15px';
        }
        if (msg.type === 'user' && lastSender === 'user') {
          bubbleDiv.style.borderTopRightRadius = '15px';
        }
        const senderSpan = document.createElement('span');
        senderSpan.className = 'sender';
        senderSpan.textContent = msg.type === 'bot' ? 'EmpathyBot' : 'You';
        bubbleDiv.appendChild(senderSpan);
        const textSpan = document.createElement('span');
        textSpan.innerHTML = msg.text.replace(/\n/g, '<br>');
        bubbleDiv.appendChild(textSpan);
        messageDiv.appendChild(bubbleDiv);
        if (msg.type === 'user') {
          const timestamp = document.createElement('span');
          timestamp.className = 'timestamp';
          timestamp.setAttribute('data-timestamp', msg.timestamp);
          messageDiv.appendChild(timestamp);
        }
        if (msg.audioUrl) {
          const audioContainer = document.createElement('div');
          audioContainer.className = 'audio-container';
          const audio = document.createElement('audio');
          audio.controls = true;
          audio.src = msg.audioUrl;
          audioContainer.appendChild(audio);
          messageDiv.appendChild(audioContainer);
        }
        chatBox.appendChild(messageDiv);
        lastSender = msg.type;
      });
      chatBox.scrollTop = chatBox.scrollHeight;
      step = conversation.step || 0;
      name = conversation.name || "";
      date = conversation.date || "";
      product = conversation.product || "";
      lastIntent = conversation.lastIntent || null;
      if (conversation.active) {
        setupMessagesFooter();
      } else {
        const footer = document.getElementById('messages-footer');
        footer.innerHTML = `
          <div class="chat-ended-message">Chat ended</div>
          <div class="contact-info">
            Customer Service Contact<br>
            customerservice@amazon.com<br>
            +1-800-123-4567<br>
            123 Amazon Way, Seattle, WA 98101
          </div>
        `;
      }
      startTimestampUpdates();
      updateNewChatOptionState();
    }

    function startTimestampUpdates() {
      function updateTimestamps() {
        const now = new Date();
        document.querySelectorAll('.timestamp').forEach(timeElement => {
          const timestamp = new Date(timeElement.getAttribute('data-timestamp'));
          timeElement.textContent = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        });
      }
      updateTimestamps();
      setInterval(updateTimestamps, 60000);
    }

    function showDetail(sectionId) {
      document.getElementById('home-main').classList.add('hidden');
      document.getElementById('search-result').classList.remove('active');
      document.querySelectorAll('.home-detail').forEach(detail => detail.classList.remove('active'));
      document.getElementById(`detail-${sectionId}`).classList.add('active');
    }

    function hideDetail() {
      document.querySelectorAll('.home-detail').forEach(detail => detail.classList.remove('active'));
      document.getElementById('home-main').classList.remove('hidden');
    }

    function detectIntent(message) {
      const lowerMessage = message.toLowerCase();
      if (lowerMessage.includes('return') || lowerMessage.includes('refund')) {
        return 'return';
      } else if (lowerMessage.includes('cancel') || lowerMessage.includes('cancellation')) {
        return 'cancel';
      } else if (lowerMessage.includes('agent') || lowerMessage.includes('human') || lowerMessage.includes('support')) {
        return 'agent';
      } else if (lowerMessage.includes('status') || lowerMessage.includes('track') || lowerMessage.includes('order')) {
        return 'status';
      }
      return 'review';
    }

    async function sendSuggestion(suggestion) {
      document.getElementById('user-input').value = suggestion;
      await sendMessage();
    }

    async function searchHelp() {
      const searchBar = document.getElementById('search-bar');
      const query = searchBar.value.trim();
      if (!query) return;

      const searchResult = document.getElementById('search-result');
      const searchResultContent = document.getElementById('search-result-content');
      searchResult.classList.add('active');
      searchResultContent.innerHTML = '<p>Loading...</p>';

      try {
        const response = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name: "User",
            date: "Unknown",
            product: "Unknown",
            input: query,
            session_id: currentConversationId || Date.now().toString(),
            intent: "search"
          })
        });
        const data = await response.json();
        if (response.ok) {
          searchResultContent.innerHTML = '';
          const p = document.createElement('p');
          p.textContent = data.reviewed_response || 'No response received.';
          searchResultContent.appendChild(p);
        } else {
          searchResultContent.innerHTML = '<p>Sorry, there was an error processing your query. Please try again later.</p>';
        }
      } catch (error) {
        searchResultContent.innerHTML = '<p>Unable to reach the server. Please check your connection and try again.</p>';
      }
    }

    function clearSearch() {
      const searchBar = document.getElementById('search-bar');
      const searchResult = document.getElementById('search-result');
      searchBar.value = '';
      searchResult.classList.remove('active');
    }

    document.getElementById('search-bar').addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        searchHelp();
      }
    });

    function resetMessagesTab() {
      const chatBox = document.getElementById('chat-box');
      const date = new Date().toLocaleDateString();
      chatBox.innerHTML = `
        <div class="chat-date">${date}</div>
        <div class="message bot">
          <div class="bubble">
            <span class="sender">EmpathyBot</span>
            <span>Hi! What's your name?</span>
          </div>
        </div>
      `;
      if (currentConversationId && conversations[currentConversationId]) {
        conversations[currentConversationId].messages = [{
          type: 'bot',
          text: "Hi! What's your name?",
          timestamp: new Date().toISOString()
        }];
        conversations[currentConversationId].active = true;
        conversations[currentConversationId].lastIntent = null;
        localStorage.setItem('conversations', JSON.stringify(conversations));
      }
      setupMessagesFooter();
      scrollToBottom();
      startTimestampUpdates();
    }

    function setupMessagesFooter() {
      const footer = document.getElementById('messages-footer');
      footer.innerHTML = `
        <div class="suggestions" id="suggestions">
          <button class="suggestion-btn" onclick="sendSuggestion('Check Order Status')">Check Order Status</button>
          <button class="suggestion-btn" onclick="sendSuggestion('Cancel Order')">Cancel Order</button>
          <button class="suggestion-btn" onclick="sendSuggestion('Talk to an Agent')">Talk to an Agent</button>
        </div>
        <div class="end-chat-btn" onclick="endChat()">End Chat</div>
        <div class="input-container">
          <div class="input-row">
            <button class="mic-btn" onclick="startVoice()">üéôÔ∏è</button>
            <input type="text" id="user-input" placeholder="Message...">
            <button class="send-btn" onclick="sendMessage()">
              <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24'><path fill='%23FFFFFF' d='M2 21l21-9L2 3v7l15 2-15 2v7z'/></svg>" alt="Send">
            </button>
          </div>
        </div>
      `;
      const input = document.getElementById('user-input');
      input.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
          event.preventDefault();
          sendMessage();
        }
      });
      input.addEventListener('focus', () => {
        document.getElementById('messages-footer').classList.add('active');
        scrollToBottom();
      });
      input.addEventListener('blur', () => {
        document.getElementById('messages-footer').classList.remove('active');
      });
      input.addEventListener('input', () => {
        scrollToBottom();
      });
    }

        function scrollToBottom() {
      const chatBox = document.getElementById('chat-box');
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function appendBotMessage(text, audioUrl, delay = 0) {
      if (!isChatActive || !currentConversationId || !conversations[currentConversationId]) return;
      setTimeout(() => {
        const chatBox = document.getElementById('chat-box');
        const typingIndicator = document.getElementById('typing-indicator');
        if (typingIndicator) typingIndicator.remove();

        const messageDiv = document.createElement('div');
        messageDiv.className = 'message bot';
        messageDiv.style.opacity = '0';
        const bubbleDiv = document.createElement('div');
        bubbleDiv.className = 'bubble';
        const lastMessage = chatBox.lastElementChild;
        if (lastMessage && lastMessage.className === 'message bot') {
          bubbleDiv.style.borderTopLeftRadius = '15px';
        }
        const senderSpan = document.createElement('span');
        senderSpan.className = 'sender';
        senderSpan.textContent = 'EmpathyBot';
        bubbleDiv.appendChild(senderSpan);
        const textSpan = document.createElement('span');
        textSpan.innerHTML = text.replace(/\n/g, '<br>');
        bubbleDiv.appendChild(textSpan);
        messageDiv.appendChild(bubbleDiv);
        if (audioUrl) {
          const audioContainer = document.createElement('div');
          audioContainer.className = 'audio-container';
          const audio = document.createElement('audio');
          audio.controls = true;
          audio.src = audioUrl;
          audioContainer.appendChild(audio);
          messageDiv.appendChild(audioContainer);
        }
        chatBox.appendChild(messageDiv);
        messageDiv.animate([
          { opacity: 0, transform: 'translateY(10px)' },
          { opacity: 1, transform: 'translateY(0)' }
        ], { duration: 500, easing: 'ease-in-out' });
        chatBox.scrollTop = chatBox.scrollHeight;
        conversations[currentConversationId].messages.push({
          type: 'bot',
          text: text,
          timestamp: new Date().toISOString(),
          audioUrl: audioUrl
        });
        conversations[currentConversationId].timestamp = new Date().toISOString();
        localStorage.setItem('conversations', JSON.stringify(conversations));
        isTyping = false;
      }, delay);
    }

    function showTypingIndicator() {
      if (isTyping) return;
      isTyping = true;
      const chatBox = document.getElementById('chat-box');
      const typingDiv = document.createElement('div');
      typingDiv.id = 'typing-indicator';
      typingDiv.className = 'typing-indicator';
      typingDiv.innerHTML = `
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      `;
      chatBox.appendChild(typingDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function sendMessage() {
      const input = document.getElementById('user-input');
      const message = input.value.trim();
      if (!message || !isChatActive || !currentConversationId || !conversations[currentConversationId]) return;
      const chatBox = document.getElementById('chat-box');
      const userMessage = document.createElement('div');
      userMessage.className = 'message user';
      const bubbleDiv = document.createElement('div');
      bubbleDiv.className = 'bubble';
      const lastMessage = chatBox.lastElementChild;
      if (lastMessage && lastMessage.className === 'message user') {
        bubbleDiv.style.borderTopRightRadius = '15px';
      }
      const senderSpan = document.createElement('span');
      senderSpan.className = 'sender';
      senderSpan.textContent = 'You';
      bubbleDiv.appendChild(senderSpan);
      const textSpan = document.createElement('span');
      textSpan.textContent = message;
      bubbleDiv.appendChild(textSpan);
      userMessage.appendChild(bubbleDiv);
      const timestamp = document.createElement('span');
      timestamp.className = 'timestamp';
      timestamp.setAttribute('data-timestamp', new Date().toISOString());
      timestamp.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      userMessage.appendChild(timestamp);
      chatBox.appendChild(userMessage);
      input.value = '';
      conversations[currentConversationId].messages.push({
        type: 'user',
        text: message,
        timestamp: new Date().toISOString(),
        showTimestamp: true
      });
      conversations[currentConversationId].lastMessage = message;
      conversations[currentConversationId].timestamp = new Date().toISOString();
      localStorage.setItem('conversations', JSON.stringify(conversations));
      showTypingIndicator();
      await handleMessage(message);
      scrollToBottom();
    }

    function groupSentences(sentences) {
      if (sentences.length <= 2 && sentences.join(' ').length <= 500) {
        return [sentences.join(' ')];
      }
      const grouped = [];
      let currentGroup = [];
      let currentLength = 0;
      sentences.forEach(sentence => {
        const sentenceLength = sentence.length;
        if (currentLength + sentenceLength <= 300 && currentGroup.length < 2) {
          currentGroup.push(sentence);
          currentLength += sentenceLength;
        } else {
          if (currentGroup.length > 0) {
            grouped.push(currentGroup.join(' '));
          }
          currentGroup = [sentence];
          currentLength = sentenceLength;
        }
      });
      if (currentGroup.length > 0) {
        grouped.push(currentGroup.join(' '));
      }
      return grouped.slice(0, 2);
    }

    async function handleMessage(message) {
      if (!isChatActive || !currentConversationId || !conversations[currentConversationId]) return;
      const convo = conversations[currentConversationId];
      const intent = detectIntent(message);

      if (intent === 'agent') {
        appendBotMessage("Please contact our customer service team at customerservice@amazon.com or +1-800-123-4567. They're ready to assist you! üòä", null, 0);
        await endChat();
        return;
      }

      if (step === 0) {
        name = message;
        convo.name = name;
        appendBotMessage(`Thanks, ${name}. When did you purchase the product?`, null, 0);
        step++;
        lastIntent = null;
      } else if (step === 1) {
        date = message;
        convo.date = date;
        appendBotMessage("Got it. What product did you purchase?", null, 0);
        step++;
        lastIntent = null;
      } else if (step === 2) {
        product = message;
        convo.product = product;
        appendBotMessage("Thanks! Now please describe your issue or feedback.", null, 0);
        step++;
        lastIntent = null;
      } else {
        try {
          const response = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              name,
              date,
              product,
              input: message,
              session_id: currentConversationId,
              intent: intent,
              last_intent: lastIntent
            })
          });
          const data = await response.json();
          if (response.ok) {
            const sentences = (data.reviewed_response || 'No response received.').split(/[.!?]\s+/).filter(s => s.trim() !== '');
            const groupedResponses = groupSentences(sentences);
            groupedResponses.forEach((responseText, index) => {
              const delay = index * 1500; // 1.5 seconds delay per message
              appendBotMessage(responseText, data.audio_url && index === groupedResponses.length - 1 ? data.audio_url : null, delay);
            });
            if (groupedResponses.length > 1) {
              showTypingIndicator();
              setTimeout(() => {
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) typingIndicator.remove();
              }, groupedResponses.length * 1500);
            }
          } else {
            appendBotMessage("Sorry, there was an error processing your query. Please try again later.", null, 0);
          }
        } catch (error) {
          appendBotMessage("Unable to reach the server. Please check your connection and try again.", null, 0);
        }
      }
      lastIntent = intent;
      convo.step = step;
      convo.lastIntent = lastIntent;
      localStorage.setItem('conversations', JSON.stringify(conversations));
    }

    function startVoice() {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-US';
      recognition.start();

      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById('user-input').value = transcript;
        sendMessage();
      };

      recognition.onerror = function(event) {
        appendBotMessage("Voice recognition error: " + event.error, null, 0);
      };
    }

    function downloadTranscript() {
      if (!currentConversationId || !conversations[currentConversationId]) return;
      const convo = conversations[currentConversationId];
      let transcript = "EmpathyBot Transcript\n\n";
      convo.messages.forEach(msg => {
        const sender = msg.type === 'bot' ? 'EmpathyBot' : 'You';
        transcript += `${sender}: ${msg.text}\n`;
        if (msg.type === 'user') {
          const timestamp = new Date(msg.timestamp);
          transcript += `(${timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })})\n`;
        }
      });
      const blob = new Blob([transcript], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `empathybot_transcript_${currentConversationId}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    document.getElementById('home-tab').onclick = () => switchTab('home');
    document.getElementById('messages-tab').onclick = () => switchTab('messages');
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EmpathyBot ❤️</title>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: flex-end;
      align-items: flex-end;
      position: relative;
      background: #F7F9FC;
      overflow-x: hidden;
    }
    .chat-widget {
      width: 400px;
      height: 600px;
      background: linear-gradient(145deg, #FFFFFF, #F0F4F8);
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      display: none;
      flex-direction: column;
      position: fixed;
      bottom: 265px;
      right: 20px;
      z-index: 1000;
      transform: translateY(100%);
      transition: transform 0.3s ease-in-out;
    }
    .chat-widget.active {
      display: flex;
      transform: translateY(0);
    }
    .tab-section {
      display: none;
      flex: 1;
      flex-direction: column;
      height: 100%;
    }
    .tab-section.active {
      display: flex;
    }
    .home-section {
      background: #6B48FF;
    }
    .home-header {
      padding: 16px;
      color: #FFFFFF;
    }
    .home-header h1 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .home-header h1 span {
      font-size: 20px;
      font-weight: 400;
    }
    .home-body {
      flex: 1;
      padding: 0 16px 16px 16px;
      overflow-y: auto;
      background: #FFFFFF;
      border-radius: 0 0 16px 16px;
    }
    .home-main {
      display: block;
    }
    .home-main.hidden {
      display: none;
    }
    .home-detail {
      display: none;
      background: #FFFFFF;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      flex: 1;
      overflow-y: auto;
    }
    .home-detail.active {
      display: block;
    }
    .home-detail-header {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }
    .home-detail-header .back-arrow {
      cursor: pointer;
      font-size: 20px;
      color: #6B48FF;
      margin-right: 8px;
    }
    .home-detail-header h2 {
      font-size: 18px;
      font-weight: 600;
      color: #1A202C;
    }
    .home-detail-content p {
      font-size: 16px;
      color: #4A5568;
      line-height: 1.5;
      margin-bottom: 8px;
    }
    .search-result {
      display: none;
      background: #FFFFFF;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
    }
    .search-result.active {
      display: block;
    }
    .search-result-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .search-result-header h2 {
      font-size: 18px;
      font-weight: 600;
      color: #1A202C;
    }
    .search-result-header .clear-search {
      cursor: pointer;
      font-size: 16px;
      color: #6B48FF;
    }
    .search-result-content p {
      font-size: 16px;
      color: #4A5568;
      line-height: 1.5;
      margin-bottom: 8px;
    }
    .recent-chats-label {
      font-size: 14px;
      color: #718096;
      margin-bottom: 4px;
    }
    .recent-message {
      background: #F7FAFC;
      padding: 10px 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 16px;
      color: #1A202C;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    .recent-message:hover {
      background: #E2E8F0;
    }
    .recent-message .arrow {
      color: #6B48FF;
      font-size: 20px;
    }
    .start-new-chat-label {
      font-size: 14px;
      color: #718096;
      margin: 8px 0 4px;
    }
    .new-chat-option {
      background: #FFFFFF;
      padding: 10px 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 16px;
      color: #1A202C;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    .new-chat-option.disabled {
      background: #E2E8F0;
      color: #A0AEC0;
      cursor: not-allowed;
    }
    .new-chat-option:hover:not(.disabled) {
      background: #F7FAFC;
    }
    .new-chat-option .arrow {
      color: #6B48FF;
      font-size: 20px;
    }
    .search-bar {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #E2E8F0;
      border-radius: 999px;
      margin: 12px 0;
      font-size: 16px;
      color: #1A202C;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path fill="%236B48FF" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>') no-repeat 95% center;
      background-size: 16px;
    }
    .search-bar:focus {
      outline: none;
      border-color: #6B48FF;
    }
    .home-item {
      background: #FFFFFF;
      padding: 10px 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 16px;
      color: #1A202C;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    .home-item:hover {
      background: #F7FAFC;
    }
    .home-item .arrow {
      color: #6B48FF;
      font-size: 20px;
    }
    .messages-header {
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #E2E8F0;
      position: sticky;
      top: 0;
      background: #FFFFFF;
      z-index: 1;
      flex-shrink: 0;
      height: 50px;
    }
    .messages-header .header-left {
      display: flex;
      align-items: center;
    }
    .messages-header .back-arrow {
      cursor: pointer;
      font-size: 20px;
      color: #6B48FF;
      margin-right: 8px;
    }
    .messages-header .header-title {
      display: flex;
      flex-direction: column;
    }
    .messages-header .header-title .title {
      font-size: 18px;
      font-weight: 600;
      color: #1A202C;
    }
    .messages-header .header-title .subtext {
      font-size: 14px;
      color: #718096;
    }
    .messages-header .download-icon {
      cursor: pointer;
      font-size: 18px;
      color: #6B48FF;
    }
    .messages-body {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
      background: #F7FAFC;
      scroll-behavior: smooth;
      min-height: 0;
    }
    .messages-body::-webkit-scrollbar {
      width: 6px;
    }
    .messages-body::-webkit-scrollbar-track {
      background: #E2E8F0;
      border-radius: 10px;
    }
    .messages-body::-webkit-scrollbar-thumb {
      background: #A0AEC0;
      border-radius: 10px;
    }
    .message {
      margin-bottom: 12px;
      display: flex;
      align-items: flex-start;
      flex-direction: column;
      flex-shrink: 0;
      opacity: 0;
      animation: fadeIn 1.5s forwards;
    }
    @keyframes fadeIn {
      to { opacity: 1; }
    }
    .message.bot {
      align-self: flex-start;
    }
    .message.user {
      align-self: flex-end;
      margin-left: auto;
    }
    .message .bubble {
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 16px;
      line-height: 1.5;
      max-width: 80%;
      display: inline-block;
      border: 1px solid #E2E8F0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    .message.bot .bubble {
      background: #FFFFFF;
      color: #1A202C;
      border-top-left-radius: 0;
    }
    .message.bot .bubble .sender {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .message.user .bubble {
      background: #6B48FF;
      color: #FFFFFF;
      border-top-right-radius: 0;
    }
    .message.user .bubble .sender {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .chat-date {
      font-size: 14px;
      color: #718096;
      text-align: center;
      margin: 8px 0;
      background: #F7FAFC;
      padding: 4px;
      border-radius: 8px;
    }
    .messages-footer {
      padding: 12px;
      background: #FFFFFF;
      border-top: 1px solid #E2E8F0;
      flex-shrink: 0;
    }
    .end-chat-btn {
      display: inline-block;
      padding: 8px 16px;
      background: #FF4D4F;
      color: #FFFFFF;
      border-radius: 999px;
      font-size: 14px;
      cursor: pointer;
      margin-bottom: 8px;
      transition: background 0.2s;
    }
    .end-chat-btn:hover {
      background: #E53E3E;
    }
    .input-container {
      display: flex;
      align-items: center;
      background: #F7FAFC;
      border-radius: 999px;
      padding: 4px;
      border: 1px solid #E2E8F0;
    }
    .input-row {
      display: flex;
      align-items: center;
      width: 100%;
    }
    #user-input {
      flex: 1;
      border: none;
      background: none;
      padding: 8px 12px;
      font-size: 16px;
      color: #1A202C;
      outline: none;
    }
    .send-btn, .mic-btn {
      background: #6B48FF;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-left: 4px;
      transition: background 0.2s;
    }
    .send-btn:hover, .mic-btn:hover {
      background: #5539CC;
    }
    .chat-ended-message {
      text-align: center;
      font-size: 14px;
      color: #718096;
      padding: 8px;
    }
    .audio-container {
      margin-top: 8px;
    }
    .audio-container audio {
      width: 100%;
    }
    .timestamp {
      font-size: 12px;
      color: #718096;
      margin-top: 4px;
      align-self: flex-end;
    }
    .navbar {
      display: flex;
      background: #FFFFFF;
      border-top: 1px solid #E2E8F0;
      padding: 8px 0;
    }
    .navbar div {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #A0AEC0;
      font-size: 14px;
      padding: 8px;
      transition: color 0.2s;
    }
    .navbar div.active {
      color: #6B48FF;
    }
    .navbar div.active svg path {
      fill: #6B48FF;
    }
    .navbar div span {
      margin-top: 4px;
    }
    .message-icon {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: #6B48FF;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: #FFFFFF;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s;
      z-index: 1000;
    }
    .message-icon:hover {
      transform: scale(1.1);
    }
    .warning-dialog {
      background: #FFF7ED;
      border: 1px solid #FEEBC8;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      position: relative;
      animation: slideIn 0.3s ease-in-out;
    }
    @keyframes slideIn {
      from { transform: translateY(-10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .warning-dialog .close-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      cursor: pointer;
      font-size: 16px;
      color: #ED8936;
    }
    .warning-dialog p {
      font-size: 14px;
      color: #7B341E;
      margin-bottom: 8px;
    }
    .warning-dialog .action-btn {
      display: inline-block;
      padding: 6px 12px;
      background: #ED8936;
      color: #FFFFFF;
      border-radius: 999px;
      font-size: 14px;
      cursor: pointer;
      text-align: center;
    }
    .warning-dialog .action-btn:hover {
      background: #DD6B20;
    }
    .suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
      justify-content: center;
    }
    .suggestion-btn {
      background: #E2E8F0;
      color: #1A202C;
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .suggestion-btn:hover {
      background: #CBD5E0;
    }
    @media (max-width: 768px) {
      .chat-widget {
        width: 100%;
        height: 80vh;
        bottom: 0;
        right: 0;
        border-radius: 0;
      }
      .message-icon {
        bottom: 10px;
        right: 10px;
        width: 50px;
        height: 50px;
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div id="chat-widget" class="chat-widget">
    <div id="home-section" class="tab-section active">
      <div class="home-header">
        <h1>EmpathyBot <span>❤️</span></h1>
      </div>
      <div class="home-body">
        <div id="home-main" class="home-main">
          <input id="search-bar" class="search-bar" type="text" placeholder="Search for help...">
          <div id="search-result" class="search-result">
            <div class="search-result-header">
              <h2>Search Results</h2>
              <span class="clear-search" onclick="clearSearch()">Clear</span>
            </div>
            <div id="search-result-content" class="search-result-content"></div>
          </div>
          <div class="start-new-chat-label">Start a New Chat</div>
          <div id="new-chat-option" class="new-chat-option" onclick="startNewChat()">
            <span>New Chat</span>
            <span class="arrow">></span>
          </div>
          <div id="detail-faqs" class="home-detail">
            <div class="home-detail-header">
              <span class="back-arrow" onclick="hideDetail()">←</span>
              <h2>Frequently Asked Questions</h2>
            </div>
            <div class="home-detail-content">
              <p><strong>How do I track my order?</strong><br>Enter your order number in the chat, and I'll provide the latest tracking information.</p>
              <p><strong>Can I cancel my order?</strong><br>Let me know your order details, and I'll guide you through the cancellation process if eligible.</p>
              <p><strong>How do I return or replace an item?</strong><br>Share the order number and item details, and I'll assist with return or replacement options.</p>
              <p><strong>How can I contact an agent?</strong><br>Request to speak to an agent in the chat, and I'll connect you with our support team.</p>
              <p>For more details, please visit our <a href="https://www.amazon.com/gp/help/customer/display.html" target="_blank">Amazon Help Center</a>.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="messages-section" class="tab-section">
      <div class="messages-header">
        <div class="header-left">
          <span class="back-arrow" onclick="switchTab('home')">←</span>
          <div class="header-title">
            <span class="title">EmpathyBot</span>
            <span class="subtext">Amazon Support</span>
          </div>
        </div>
        <span class="download-icon" onclick="downloadTranscript()">⬇</span>
      </div>
      <div id="chat-box" class="messages-body"></div>
      <div id="messages-footer" class="messages-footer">
        <div class="end-chat-btn" onclick="endChat()">End Chat</div>
        <div class="input-container">
          <div class="input-row">
            <input type="text" id="user-input" placeholder="Message...">
            <button class="send-btn" onclick="sendMessage()">
              <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#FFFFFF" d="M2 21l21-9L2 3v7l15 2-15 2v7z"/></svg>
            </button>
            <button class="mic-btn" onclick="startVoice()">
              <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#FFFFFF" d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.47 6 6.93V21h2v-3.07c3.39-.46 6-3.4 6-6.93h-2z"/></svg>
            </button>
          </div>
        </div>
        <div class="suggestions" id="suggestions" style="display: none;">
          <button class="suggestion-btn" onclick="sendSuggestion('Check Order Status')">Check Order Status</button>
          <button class="suggestion-btn" onclick="sendSuggestion('Cancel Order')">Cancel Order</button>
          <button class="suggestion-btn" onclick="sendSuggestion('Talk to an Agent')">Talk to an Agent</button>
          <button class="suggestion-btn" onclick="showFAQ()">View FAQs</button>
        </div>
      </div>
    </div>
    <div class="navbar">
      <div id="home-tab" class="active">
        <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#6B48FF" d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
        <span>Home</span>
      </div>
      <div id="messages-tab">
        <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#A0AEC0" d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
        <span>Messages</span>
      </div>
    </div>
  </div>
  <div class="message-icon" onclick="toggleChat()">❤️</div>

  <script>
    let name = "";
    let date = "";
    let product = "";
    let step = 0;
    let currentConversationId = null;
    let conversations = JSON.parse(localStorage.getItem('conversations')) || {};
    let isChatActive = false;

    function toggleChat() {
      const chatWidget = document.getElementById('chat-widget');
      chatWidget.classList.toggle('active');
      if (chatWidget.classList.contains('active')) {
        startTimestampUpdates();
        updateNewChatOptionState();
      }
    }

    function switchTab(tab) {
      document.querySelectorAll('.navbar div').forEach(div => div.classList.remove('active'));
      document.querySelectorAll('.tab-section').forEach(section => section.classList.remove('active'));
      document.getElementById(`${tab}-tab`).classList.add('active');
      document.getElementById(`${tab}-section`).classList.add('active');
      if (tab === 'messages') {
        if (!isChatActive) {
          loadConversationsList();
        }
      } else if (tab === 'home') {
        if (currentConversationId && conversations[currentConversationId]) {
          isChatActive = conversations[currentConversationId].active;
        } else {
          isChatActive = false;
        }
        hideDetail();
        clearSearch();
        startTimestampUpdates();
        updateNewChatOptionState();
      }
    }

    function showWarningDialog() {
      const homeBody = document.querySelector('#home-section .home-body');
      const existingWarning = document.querySelector('.warning-dialog');
      if (existingWarning) existingWarning.remove();
      const warningDiv = document.createElement('div');
      warningDiv.className = 'warning-dialog';
      warningDiv.innerHTML = `
        <span class="close-btn" onclick="this.parentElement.remove()">×</span>
        <p>Please end the current chat before starting a new one.</p>
        <div class="action-btn" onclick="switchTab('messages'); this.parentElement.remove()">Go to Chat</div>
      `;
      homeBody.insertBefore(warningDiv, homeBody.firstChild);
      homeBody.scrollTop = 0;
    }

    function updateNewChatOptionState() {
      const newChatOption = document.getElementById('new-chat-option');
      if (isChatActive) {
        newChatOption.classList.add('disabled');
        newChatOption.onclick = showWarningDialog;
      } else {
        newChatOption.classList.remove('disabled');
        newChatOption.onclick = startNewChat;
      }
    }

    function startNewChat() {
      if (isChatActive) {
        showWarningDialog();
        return;
      }
      currentConversationId = Date.now().toString();
      step = 0;
      isChatActive = true;
      conversations[currentConversationId] = {
        messages: [],
        lastMessage: "",
        timestamp: new Date().toISOString(),
        name: "",
        date: "",
        product: "",
        step: 0,
        active: true
      };
      switchTab('messages');
      resetMessagesTab();
      updateNewChatOptionState();
    }

    async function endChat() {
      if (currentConversationId && conversations[currentConversationId]) {
        appendBotMessage("Would you like to share any feedback before we end this chat? 😊");
        const suggestions = document.getElementById('suggestions');
        suggestions.style.display = 'flex';
        suggestions.innerHTML = `
          <button class="suggestion-btn" onclick="sendSuggestion('The service was great!')">The service was great!</button>
          <button class="suggestion-btn" onclick="sendSuggestion('It could be better.')">It could be better.</button>
          <button class="suggestion-btn" onclick="confirmEndChat()">No feedback, end chat</button>
        `;
      }
    }

    async function confirmEndChat() {
      if (currentConversationId && conversations[currentConversationId]) {
        await fetch('/end_chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: currentConversationId })
        });
        conversations[currentConversationId].active = false;
        appendBotMessage("Chat ended. Start a new chat from the Home tab. ❤️");
        const footer = document.getElementById('messages-footer');
        footer.innerHTML = `<div class="chat-ended-message">Chat ended</div>`;
        localStorage.setItem('conversations', JSON.stringify(conversations));
        isChatActive = false;
        currentConversationId = null;
        switchTab('home');
        updateNewChatOptionState();
      }
    }

    function loadConversationsList() {
      if (isChatActive) return;
      const chatBox = document.getElementById('chat-box');
      const footer = document.getElementById('messages-footer');
      chatBox.innerHTML = '';
      footer.innerHTML = '';
      const conversationIds = Object.keys(conversations)
        .sort((a, b) => new Date(conversations[b].timestamp) - new Date(conversations[a].timestamp));
      if (conversationIds.length > 0) {
        const label = document.createElement('div');
        label.className = 'recent-chats-label';
        label.textContent = 'Recent Chats';
        chatBox.appendChild(label);
      }
      conversationIds.forEach(id => {
        const convo = conversations[id];
        if (convo.lastMessage) {
          const messageDiv = document.createElement('div');
          messageDiv.className = 'recent-message';
          messageDiv.onclick = () => loadConversation(id);
          messageDiv.innerHTML = `
            <div style="display: flex; align-items: center;">
              <span>${convo.lastMessage.slice(0, 20)}${convo.lastMessage.length > 20 ? '...' : ''}</span>
            </div>
            <span class="arrow">></span>
          `;
          chatBox.appendChild(messageDiv);
        }
      });
      scrollToBottom();
    }

    function loadConversation(conversationId) {
      currentConversationId = conversationId;
      const conversation = conversations[conversationId];
      isChatActive = conversation.active;
      const chatBox = document.getElementById('chat-box');
      chatBox.innerHTML = `<div class="chat-date">${new Date(conversation.timestamp).toLocaleDateString()}</div>`;
      let lastSender = null;
      conversation.messages.forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${msg.type}`;
        const bubbleDiv = document.createElement('div');
        bubbleDiv.className = 'bubble';
        if (msg.type === 'bot' && lastSender === 'bot') {
          bubbleDiv.style.borderTopLeftRadius = '12px';
        }
        if (msg.type === 'user' && lastSender === 'user') {
          bubbleDiv.style.borderTopRightRadius = '12px';
        }
        const senderSpan = document.createElement('span');
        senderSpan.className = 'sender';
        senderSpan.textContent = msg.type === 'bot' ? 'EmpathyBot' : 'You';
        bubbleDiv.appendChild(senderSpan);
        const textSpan = document.createElement('span');
        textSpan.innerHTML = msg.text.replace(/\n/g, '<br>');
        bubbleDiv.appendChild(textSpan);
        messageDiv.appendChild(bubbleDiv);
        if (msg.type === 'user') {
          const timestamp = document.createElement('span');
          timestamp.className = 'timestamp';
          timestamp.setAttribute('data-timestamp', msg.timestamp);
          messageDiv.appendChild(timestamp);
        }
        chatBox.appendChild(messageDiv);
        lastSender = msg.type;
      });
      chatBox.scrollTop = chatBox.scrollHeight;
      step = conversation.step || 0;
      name = conversation.name || "";
      date = conversation.date || "";
      product = conversation.product || "";
      if (conversation.active) {
        setupMessagesFooter();
      } else {
        const footer = document.getElementById('messages-footer');
        footer.innerHTML = `<div class="chat-ended-message">Chat ended</div>`;
      }
      startTimestampUpdates();
      updateNewChatOptionState();
    }

    function startTimestampUpdates() {
      function updateTimestamps() {
        const now = new Date();
        document.querySelectorAll('.timestamp').forEach(timeElement => {
          const timestamp = new Date(timeElement.getAttribute('data-timestamp'));
          const diffMs = now - timestamp;
          const diffMinutes = Math.floor(diffMs / 1000 / 60);
          const diffHours = Math.floor(diffMinutes / 60);
          const diffDays = Math.floor(diffHours / 24);
          if (diffMinutes < 1) timeElement.textContent = 'Just now';
          else if (diffMinutes < 60) timeElement.textContent = `${diffMinutes}m ago`;
          else if (diffHours < 24) timeElement.textContent = `${diffHours}h ago`;
          else timeElement.textContent = `${diffDays}d ago`;
        });
      }
      updateTimestamps();
      setInterval(updateTimestamps, 60000);
    }

    function showDetail(sectionId) {
      document.getElementById('home-main').classList.add('hidden');
      document.getElementById('search-result').classList.remove('active');
      document.querySelectorAll('.home-detail').forEach(detail => detail.classList.remove('active'));
      document.getElementById(`detail-${sectionId}`).classList.add('active');
    }

    function hideDetail() {
      document.querySelectorAll('.home-detail').forEach(detail => detail.classList.remove('active'));
      document.getElementById('home-main').classList.remove('hidden');
    }

    async function searchHelp() {
      const searchBar = document.getElementById('search-bar');
      const query = searchBar.value.trim();
      if (!query) return;
      const searchResult = document.getElementById('search-result');
      const searchResultContent = document.getElementById('search-result-content');
      searchResult.classList.add('active');
      searchResultContent.innerHTML = '<p>Loading...</p>';
      try {
        const response = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name: "User",
            date: "Unknown",
            product: "Unknown",
            input: query,
            session_id: currentConversationId || Date.now().toString()
          })
        });
        const data = await response.json();
        if (response.ok) {
          searchResultContent.innerHTML = '';
          const p = document.createElement('p');
          p.textContent = data.reviewed_response || 'No response received.';
          searchResultContent.appendChild(p);
        } else {
          searchResultContent.innerHTML = '<p>Sorry, there was an error processing your query. Please try again later.</p>';
        }
      } catch (error) {
        searchResultContent.innerHTML = '<p>Unable to reach the server. Please check your connection and try again.</p>';
      }
    }

    function clearSearch() {
      const searchBar = document.getElementById('search-bar');
      const searchResult = document.getElementById('search-result');
      searchBar.value = '';
      searchResult.classList.remove('active');
    }

    document.getElementById('search-bar').addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        searchHelp();
      }
    });

    function resetMessagesTab() {
      const chatBox = document.getElementById('chat-box');
      const date = new Date().toLocaleDateString();
      chatBox.innerHTML = `
        <div class="chat-date">${date}</div>
        <div class="message bot">
          <div class="bubble">
            <span class="sender">EmpathyBot</span>
            <span>Hi! What's your name?</span>
          </div>
        </div>
      `;
      if (currentConversationId && conversations[currentConversationId]) {
        conversations[currentConversationId].messages = [{
          type: 'bot',
          text: "Hi! What's your name?",
          timestamp: new Date().toISOString()
        }];
        conversations[currentConversationId].active = true;
        localStorage.setItem('conversations', JSON.stringify(conversations));
      }
      setupMessagesFooter();
      scrollToBottom();
      startTimestampUpdates();
    }

    function setupMessagesFooter() {
      const footer = document.getElementById('messages-footer');
      footer.innerHTML = `
        <div class="end-chat-btn" onclick="endChat()">End Chat</div>
        <div class="input-container">
          <div class="input-row">
            <input type="text" id="user-input" placeholder="Message...">
            <button class="send-btn" onclick="sendMessage()">
              <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#FFFFFF" d="M2 21l21-9L2 3v7l15 2-15 2v7z"/></svg>
            </button>
            <button class="mic-btn" onclick="startVoice()">
              <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#FFFFFF" d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.47 6 6.93V21h2v-3.07c3.39-.46 6-3.4 6-6.93h-2z"/></svg>
            </button>
          </div>
        </div>
        <div class="suggestions" id="suggestions" style="display: none;">
          <button class="suggestion-btn" onclick="sendSuggestion('Check Order Status')">Check Order Status</button>
          <button class="suggestion-btn" onclick="sendSuggestion('Cancel Order')">Cancel Order</button>
          <button class="suggestion-btn" onclick="sendSuggestion('Talk to an Agent')">Talk to an Agent</button>
          <button class="suggestion-btn" onclick="showFAQ()">View FAQs</button>
        </div>
      `;
      document.getElementById('user-input').addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
          event.preventDefault();
          sendMessage();
        }
      });
    }

    function scrollToBottom() {
      const chatBox = document.getElementById('chat-box');
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function appendBotMessage(text, audioUrl) {
      if (!isChatActive || !currentConversationId || !conversations[currentConversationId]) return;
      const chatBox = document.getElementById('chat-box');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message bot';
      const bubbleDiv = document.createElement('div');
      bubbleDiv.className = 'bubble';
      const lastMessage = chatBox.lastElementChild;
      if (lastMessage && lastMessage.className.includes('message bot')) {
        bubbleDiv.style.borderTopLeftRadius = '12px';
      }
      const senderSpan = document.createElement('span');
      senderSpan.className = 'sender';
      senderSpan.textContent = 'EmpathyBot';
      bubbleDiv.appendChild(senderSpan);
      const textSpan = document.createElement('span');
      textSpan.innerHTML = text.replace(/\n/g, '<br>');
      bubbleDiv.appendChild(textSpan);
      messageDiv.appendChild(bubbleDiv);
      if (audioUrl) {
        const audioContainer = document.createElement('div');
        audioContainer.className = 'audio-container';
        const audio = document.createElement('audio');
        audio.controls = true;
        audio.src = audioUrl;
        audioContainer.appendChild(audio);
        messageDiv.appendChild(audioContainer);
      }
      chatBox.appendChild(messageDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
      conversations[currentConversationId].messages.push({
        type: 'bot',
        text: text,
        timestamp: new Date().toISOString(),
        audioUrl: audioUrl
      });
      conversations[currentConversationId].timestamp = new Date().toISOString();
      localStorage.setItem('conversations', JSON.stringify(conversations));
    }

    async function sendMessage() {
      const input = document.getElementById('user-input');
      let message = input.value.trim();
      if (!message || !isChatActive || !currentConversationId || !conversations[currentConversationId]) return;
      const chatBox = document.getElementById('chat-box');
      const userMessage = document.createElement('div');
      userMessage.className = 'message user';
      const bubbleDiv = document.createElement('div');
      bubbleDiv.className = 'bubble';
      const lastMessage = chatBox.lastElementChild;
      if (lastMessage && lastMessage.className.includes('message user')) {
        bubbleDiv.style.borderTopRightRadius = '12px';
      }
      const senderSpan = document.createElement('span');
      senderSpan.className = 'sender';
      senderSpan.textContent = 'You';
      bubbleDiv.appendChild(senderSpan);
      const textSpan = document.createElement('span');
      textSpan.textContent = message;
      bubbleDiv.appendChild(textSpan);
      userMessage.appendChild(bubbleDiv);
      const timestamp = document.createElement('span');
      timestamp.className = 'timestamp';
      timestamp.setAttribute('data-timestamp', new Date().toISOString());
      timestamp.textContent = 'Just now';
      userMessage.appendChild(timestamp);
      chatBox.appendChild(userMessage);
      input.value = '';
      conversations[currentConversationId].messages.push({
        type: 'user',
        text: message,
        timestamp: new Date().toISOString(),
        showTimestamp: true
      });
      conversations[currentConversationId].lastMessage = message;
      conversations[currentConversationId].timestamp = new Date().toISOString();
      localStorage.setItem('conversations', JSON.stringify(conversations));
      await handleMessage(message);
      scrollToBottom();
    }

    async function handleMessage(message) {
      if (!isChatActive || !currentConversationId || !conversations[currentConversationId]) return;
      const convo = conversations[currentConversationId];
      if (step === 0) {
        name = message.replace(/my name is /i, '').trim();
        convo.name = name;
        appendBotMessage(`Dear ${name}, how may I help you today? 😊`);
        step++;
        convo.step = step;
        const suggestions = document.getElementById('suggestions');
        suggestions.style.display = 'flex';
      } else {
        try {
          const response = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              name,
              date,
              product,
              input: message,
              session_id: currentConversationId
            })
          });
          const data = await response.json();
          if (response.ok) {
            appendBotMessage(data.reviewed_response || 'No response received.');
          } else {
            appendBotMessage("Sorry, there was an error processing your query. Please try again later.");
          }
        } catch (error) {
          appendBotMessage("Unable to reach the server. Please check your connection and try again.");
        }
      }
      localStorage.setItem('conversations', JSON.stringify(conversations));
    }

    function sendSuggestion(suggestion) {
      document.getElementById('user-input').value = suggestion;
      sendMessage();
    }

    function showFAQ() {
      showDetail('faqs');
    }

    function startVoice() {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-US';
      recognition.start();
      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById('user-input').value = transcript;
        sendMessage();
      };
      recognition.onerror = function(event) {
        appendBotMessage("Voice recognition error: " + event.error);
      };
    }

    function downloadTranscript() {
      if (!currentConversationId || !conversations[currentConversationId]) return;
      const convo = conversations[currentConversationId];
      let transcript = "EmpathyBot Transcript\n\n";
      convo.messages.forEach(msg => {
        const sender = msg.type === 'bot' ? 'EmpathyBot' : 'You';
        transcript += `${sender}: ${msg.text}\n`;
        if (msg.type === 'user') {
          const timestamp = new Date(msg.timestamp);
          const diffMs = Date.now() - timestamp;
          const diffMinutes = Math.floor(diffMs / 1000 / 60);
          const diffHours = Math.floor(diffMinutes / 60);
          const diffDays = Math.floor(diffHours / 24);
          let timeText = diffMinutes < 1 ? 'Just now' : diffMinutes < 60 ? `${diffMinutes}m ago` : diffHours < 24 ? `${diffHours}h ago` : `${diffDays}d ago`;
          transcript += `(${timeText})\n`;
        }
      });
      const blob = new Blob([transcript], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `empathybot_transcript_${currentConversationId}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    document.getElementById('home-tab').onclick = () => switchTab('home');
    document.getElementById('messages-tab').onclick = () => switchTab('messages');
  </script>
</body>
</html>
